<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoftCoin</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="balance">
        <div class="icon-coin-back">
            <div class="icon-coin">S</div>
        </div>
        <p id="balance">0</p>
    </div>
    <div class="center">
        <div class="coin-back" id="button">
            <div class="coin">S</div>
        </div>
    </div>
    <!-- <div class="level-up">
        <span class="plus">+</span>
        <span>Darajangiz oshdi</span>
    </div> -->
    <p class="energy">100/100</p>
    <script src="supabase.js"></script>

    <script>
        const url = 'https://zdelswetcocypedqkqwm.supabase.co'
        const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkZWxzd2V0Y29jeXBlZHFrcXdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjI1Njk4NTcsImV4cCI6MjAzODE0NTg1N30.c-oWVYU3I5ZYlpP1-m-uGPIEKn0PAyF4m9TKmKfKPUM'
        const _supabase = supabase.createClient(url, key)
        const user_id = new URLSearchParams(window.location.search).get('user_id')
        const levels = {
            1: {
                level: 1,
                energy: 100,
                avatar: '../static/level1.png'
            },
            1000: {
                level: 2,
                energy: 200,
                avatar: '../static/level2.png'
            },
            10000: {
                level: 3,
                energy: 300,
                avatar: '../static/level3.png'
            },
            50000: {
                level: 4,
                energy: 400,
                avatar: '../static/level4.png'
            },
            100000: {
                level: 5,
                energy: 500,
                avatar: '../static/level5.png'
            },
            1000000: {
                level: 6,
                energy: 600,
                avatar: '../static/level6.png'
            },
            10000000: {
                level: 7,
                energy: 700,
                avatar: '../static/level7.png'
            }
        }
        const level_up = Object.keys(levels)
        async function main() {
            const { data } = await _supabase.from('users').select('*').eq('user_id', user_id).single()
            return data
        }
        async function update_balance(balance) {
            const data = await _supabase.from('users').update({ balance: balance }).eq('user_id', user_id)
            return data
        }

        async function update_setenergy(setenrgy) {
            const data = await _supabase.from('users').update({ setenergy: setenrgy }).eq('user_id', user_id)
            return data
        }

        async function update_level(level) {
            const data = await _supabase.from('users').update({ level: level }).eq('user_id', user_id)
            return data
        }

        let balance
        let setenrgy
        let energy

        main().then(data => {
            balance = data.balance
            if (balance >= 1000 && balance < 1000000) {
                if (String(balance / 1000).split('.').length == 1 || String(balance / 1000).split('.')[1][0] == 0) {
                    document.getElementById("balance").innerText = String(balance / 1000).split('.')[0] + ' ming'
                } else {
                    document.getElementById("balance").innerText = String(balance / 1000).split('.')[0] + ',' + String(balance / 1000).split('.')[1][0] + ' ming'
                }
            } else if (balance >= 1000000) {
                if (String(balance / 1000000).split('.').length == 1 || String(balance / 1000000).split('.')[1][0] == 0) {
                    document.getElementById("balance").innerText = String(balance / 1000000).split('.')[0] + ' ming'
                } else {
                    document.getElementById("balance").innerText = String(balance / 1000000).split('.')[0] + ',' + String(balance / 1000000).split('.')[1][0] + ' ming'
                }
                document.getElementById("balance").innerText = String(balance / 1000000).split('.')[0] + ' mln'
            } else {
                document.getElementById("balance").innerText = balance
            }
            setenrgy = data.setenergy
            energy = data.setenergy
            document.getElementsByClassName("energy")[0].innerText = energy + '/' + setenrgy
        })
        document.getElementById("button").onclick = function (event) {
            if (energy <= 0) {
                return
            }
            let x = event.clientX;
            let y = event.clientY;
            balance++
            const small = document.createElement("div");
            small.classList.add("small-coin-back");
            const c = document.createElement("div");
            c.classList.add("small-coin");
            c.innerText = 'S'
            small.appendChild(c);
            document.getElementsByTagName("body")[0].appendChild(small);
            small.style.left = x + 'px';
            small.style.top = y + 'px';
            for (let i = 0; i < 100; i++) {
                setTimeout(function () {
                    small.style.top = y - i * 3 + 'px';
                    small.style.opacity = 1 - i / 100;
                    if (i == 99) {
                        small.remove();
                    }
                }, i * 10);
            }
            energy--
            document.getElementsByClassName("energy")[0].innerText = energy + '/' + setenrgy
            if (balance >= 1000 && balance < 1000000) {
                if (String(balance / 1000).split('.').length == 1 || String(balance / 1000).split('.')[1][0] == 0) {
                    document.getElementById("balance").innerText = String(balance / 1000).split('.')[0] + ' ming'
                } else {
                    document.getElementById("balance").innerText = String(balance / 1000).split('.')[0] + ',' + String(balance / 1000).split('.')[1][0] + ' ming'
                }
            } else if (balance >= 1000000) {
                if (String(balance / 1000000).split('.').length == 1 || String(balance / 1000000).split('.')[1][0] == 0) {
                    document.getElementById("balance").innerText = String(balance / 1000000).split('.')[0] + ' ming'
                } else {
                    document.getElementById("balance").innerText = String(balance / 1000000).split('.')[0] + ',' + String(balance / 1000000).split('.')[1][0] + ' ming'
                }
                document.getElementById("balance").innerText = String(balance / 1000000).split('.')[0] + ' mln'
            } else {
                document.getElementById("balance").innerText = balance
            }
            update_balance(balance)
            if (balance in level_up && levels[balance].level != 1) {
                const current = levels[balance]

                const level_up_div = document.createElement("div");
                level_up_div.classList.add("level-up");
                plus = document.createElement("span");
                plus.classList.add("plus");
                plus.innerText = '+'
                level_up_div.appendChild(plus);
                const sp = document.createElement("span");
                sp.innerText = 'Darajangiz oshdi'
                level_up_div.appendChild(sp);
                document.getElementsByTagName("body")[0].appendChild(level_up_div);
                level_up_div.style.top = '50%';
                level_up_div.style.left = window.innerWidth / 2 - 130 + 'px';

                for (let i = 0; i < 100; i += 2) {
                    setTimeout(function () {
                        level_up_div.style.top = window.innerHeight / 2 - i * 3 + 'px';
                        level_up_div.style.opacity = 1 - i / 100;
                        if (i == 99) {
                            level_up_div.remove();
                        }
                    }, i * 10);
                }
                setenrgy = current.energy
                energy = current.energy
                update_setenergy(setenrgy)
                update_level(current.level)
                
                document.getElementsByClassName("energy")[0].innerText = energy + '/' + setenrgy
            }

        }

        setInterval(function () {
            if (energy > setenrgy - 3) {
                energy += setenrgy - energy
                document.getElementsByClassName("energy")[0].innerText = energy + '/' + setenrgy
            }
            if (energy < setenrgy) {
                energy += 3
                document.getElementsByClassName("energy")[0].innerText = energy + '/' + setenrgy
            }
        }, 2000)
    </script>
</body>

</html>
